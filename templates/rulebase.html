<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rule Form</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        .flex-container {
            display: flex;
            flex-wrap: wrap;
        }
        .flex-item {
            flex: 1 1 20%;
            margin: 5px;
        }
        .center-buttons {
            text-align: center;
        }
        .condition-group, .rule-group {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Rule for Disease ABC</h2>


        <!-- Add the form tag here -->
        <form action="{{ url_for('rulebase') }}" method="POST" id="rule-form">
            <!-- Disease Codes Section -->
            <div id="disease-codes">
                <h4>Disease Codes</h4>
                <div class="disease-code" id="disease-code-1">
                    <div class="form-group">
                        <label for="disease-name-1">Disease Name:</label>
                        <input type="text" class="form-control" id="disease-name-1" name="disease_names[]" placeholder="Enter Disease Name" required>
                    </div>
                    <div class="form-group">
                        <label for="disease-code-1">Disease Code:</label>
                        <input type="text" class="form-control" id="disease-code-1" name="disease_codes[]" placeholder="Enter Disease Code" required>
                    </div>
                    <div class="center-buttons">
                        <button type="button" class="btn btn-danger remove-disease-code" style="display: none;">Remove Disease Code</button>
                    </div>
                </div>
            </div>
            <div class="center-buttons">
                <button type="button" id="add-disease-code" class="btn btn-success">Add New Disease Code</button>
            </div>

            <!-- Rules Section -->
            <div id="rules">
                <h4>Rules</h4>
                <!-- Rule Template -->
                <div class="rule-group" id="rule-1">
                    <h5>Rule 1</h5>
                    <div class="conditions" id="conditions-1">
                        <!-- Condition Template -->
                        <div class="condition-group" id="condition-1-1">
                            <h6>Condition 1</h6>
                            <div class="flex-container">
                                <div class="form-group flex-item">
                                    <label for="condition-type-1-1">Condition Type:</label>
                                    <select class="form-control condition-type" id="condition-type-1-1" name="conditions[1][]">
                                        <option value="range">Range Condition</option>
                                        <option value="comparison">Comparison Condition</option>
                                        <option value="time">Time Dependent Condition</option>


                                    </select>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="parameter-1-1">Parameter:</label>
                                    <select class="form-control parameter" id="parameter-1-1" name="parameters[1][]">
                                        <option value="Hemoglobin">Hemoglobin</option>
                                        <option value="Glucose">Glucose</option>
                                        <option value="Potassium">Potassium</option>
                                        <option value="gl">GL</option>
                                        <option value="Sodium">Sodium</option>
                                    </select>
                                </div>
                                <div class="form-group flex-item range-condition" style="display: none;">
                                    <label for="min-value-1-1">Minimum Value:</label>
                                    <input type="number" class="form-control min-value" id="min-value-1-1" name="min_values[1][]" placeholder="Enter minimum value" step="0.01">
                                </div>
                                <div class="form-group flex-item range-condition" style="display: none;">
                                    <label for="max-value-1-1">Maximum Value:</label>
                                    <input type="number" class="form-control max-value" id="max-value-1-1" name="max_values[1][]" placeholder="Enter maximum value" step="0.01">
                                </div>
                                <div class="form-group flex-item comparison-condition" style="display: none;">
                                    <label for="operator-1-1">Operator:</label>
                                    <select class="form-control operator" id="operator-1-1" name="operators[1][]">
                                        <option value="greater">></option>
                                        <option value="less"><</option>
                                        <option value="equal">=</option>
                                        <option value="greater or equal">>=</option>
                                        <option value="less or equal"><=</option>
                                    </select>
                                </div>
                                <div class="form-group flex-item comparison-condition" style="display: none;">
                                    <label for="value-1-1">Value:</label>
                                    <input type="number" class="form-control comparison-value" id="value-1-1" name="comparison_values[1][]" placeholder="Enter value">
                                </div>



                                <div class="form-group flex-item">
                                    <label for="unit-1-1">Unit:</label>
                                    <select class="form-control unit" id="unit-1-1" name="units[1][]">
                                        <option value="mg/dL">mg/dL</option>
                                        <option value="g/dL">g/dL</option>
                                        <option value="mmHg">mmHg</option>
                                        <option value="%">%</option>
                                        <option value="bpm">bpm</option>
                                    </select>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="age-min-1-1">Age Range:</label>
                                    <input type="number" class="form-control age-min" id="age-min-1-1" name="age_min[1][]" placeholder="From Age" min="0" required>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="age-max-1-1">Age Range:</label>
                                    <input type="number" class="form-control age-max" id="age-max-1-1" name="age_max[1][]" placeholder="To Age" min="0" required>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="gender-1-1">Gender:</label>
                                    <select class="form-control gender" id="gender-1-1" name="genders[1][]" required>
                                        <option value="all">ALL</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                            <div class="center-buttons">
                                <button type="button" class="btn btn-danger remove-condition" style="display: none;">Remove Condition</button>
                            </div>
                        </div>
                    </div>
                    <div class="center-buttons">
                        <button type="button" class="btn btn-primary add-condition" data-rule="1">Add Condition</button>
                        <button type="button" class="btn btn-danger remove-rule" style="display: none;">Remove Rule</button>
                    </div>
                </div>
            </div>

            <div class="center-buttons">
                <button type="button" id="add-rule" class="btn btn-success">Add New Rule</button>
            </div>
<br>
<br>

            <!-- Submit Button -->
            <div class="center-buttons">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>

    <!-- JavaScript to Handle Dynamic Form Elements -->
    <script>
    $(document).ready(function () {
        let ruleCount = 1;
        let conditionCount = 1;
        let diseaseCodeCount = 1;

        function toggleConditionFields(conditionRow, selectedType) {
            if (selectedType === 'range') {
                conditionRow.find('.range-condition').show();
                conditionRow.find('.comparison-condition').hide();
                conditionRow.find('.comparison-value').removeAttr('required');
            } else if (selectedType === 'comparison') {
                conditionRow.find('.comparison-condition').show();
                conditionRow.find('.range-condition').hide();
                conditionRow.find('.comparison-value').attr('required', 'required');
            }
        }

function initializeConditionFields() {
    $('.condition-type').each(function () {
        const conditionGroup = $(this).closest('.condition-group');
        if ($(this).val() === 'range') {
            conditionGroup.find('.range-condition').show();
            conditionGroup.find('.comparison-condition').hide();
        } else {
            conditionGroup.find('.range-condition').hide();
            conditionGroup.find('.comparison-condition').show();
        }
    });

    $('.condition-type').change(function () {
        const conditionGroup = $(this).closest('.condition-group');
        if ($(this).val() === 'range') {
            conditionGroup.find('.range-condition').show();
            conditionGroup.find('.comparison-condition').hide();
        } else {
            conditionGroup.find('.range-condition').hide();
            conditionGroup.find('.comparison-condition').show();
        }
    });
}
        // Add new disease code
        $('#add-disease-code').click(function () {
            diseaseCodeCount++;
            const diseaseCodeHtml = `
                <div class="disease-code" id="disease-code-${diseaseCodeCount}">
                    <div class="form-group">
                        <label for="disease-name-${diseaseCodeCount}">Disease Name:</label>
                        <input type="text" class="form-control" id="disease-name-${diseaseCodeCount}" name="disease_names[]" placeholder="Enter Disease Name" required>
                    </div>
                    <div class="form-group">
                        <label for="disease-code-${diseaseCodeCount}">Disease Code:</label>
                        <input type="text" class="form-control" id="disease-code-${diseaseCodeCount}" name="disease_codes[]" placeholder="Enter Disease Code" required>
                    </div>
                    <div class="center-buttons">
                        <button type="button" class="btn btn-danger remove-disease-code" style="display: block;">Remove Disease Code</button>
                    </div>
                </div>
            `;
            $('#disease-codes').append(diseaseCodeHtml);
            updateRemoveButtons();
        });

        // Add new rule
        $('#add-rule').click(function () {
            ruleCount++;
            conditionCount = 1;
            const ruleHtml = `
                <div class="rule-group" id="rule-${ruleCount}">
                    <h5>Rule ${ruleCount}</h5>
                    <div class="conditions" id="conditions-${ruleCount}">
                        <div class="condition-group" id="condition-${ruleCount}-1">
                            <h6>Condition 1</h6>
                            <div class="flex-container">
                                <div class="form-group flex-item">
                                    <label for="condition-type-${ruleCount}-1">Condition Type:</label>
                                    <select class="form-control condition-type" id="condition-type-${ruleCount}-1" name="conditions[${ruleCount}][]">
                                        <option value="range">Range Condition</option>
                                        <option value="comparison">Comparison Condition</option>
                                    </select>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="parameter-${ruleCount}-1">Parameter:</label>
                                    <select class="form-control parameter" id="parameter-${ruleCount}-1" name="parameters[${ruleCount}][]">
                                        <option value="Hemoglobin">Hemoglobin</option>
                                        <option value="Glucose">Glucose</option>
                                        <option value="Potassium">Potassium</option>
                                        <option value="gl">GL</option>
                                        <option value="Sodium">Sodium</option>
                                    </select>
                                </div>
                                <div class="form-group flex-item range-condition" style="display: none;">
                                    <label for="min-value-${ruleCount}-1">Minimum Value:</label>
                                    <input type="number" class="form-control min-value" id="min-value-${ruleCount}-1" name="min_values[${ruleCount}][]" placeholder="Enter minimum value">
                                </div>
                                <div class="form-group flex-item range-condition" style="display: none;">
                                    <label for="max-value-${ruleCount}-1">Maximum Value:</label>
                                    <input type="number" class="form-control max-value" id="max-value-${ruleCount}-1" name="max_values[${ruleCount}][]" placeholder="Enter maximum value">
                                </div>
                                <div class="form-group flex-item comparison-condition" style="display: none;">
                                    <label for="operator-${ruleCount}-1">Operator:</label>
                                    <select class="form-control operator" id="operator-${ruleCount}-1" name="operators[${ruleCount}][]">
                                        <option value="greater">></option>
                                        <option value="less"><</option>
                                        <option value="equal">=</option>
                                    </select>
                                </div>
                                <div class="form-group flex-item comparison-condition" style="display: none;">
                                    <label for="value-${ruleCount}-1">Value:</label>
                                    <input type="number" class="form-control comparison-value" id="value-${ruleCount}-1" name="comparison_values[${ruleCount}][]" placeholder="Enter value">
                                </div>
                                <div class="form-group flex-item">
                                    <label for="unit-${ruleCount}-1">Unit:</label>
                                    <select class="form-control unit" id="unit-${ruleCount}-1" name="units[${ruleCount}][]">
                                        <option value="mg/dL">mg/dL</option>
                                        <option value="g/dL">g/dL</option>
                                        <option value="mmHg">mmHg</option>
                                        <option value="%">%</option>
                                        <option value="bpm">bpm</option>
                                    </select>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="age-min-${ruleCount}-1">Age Range:</label>
                                    <input type="number" class="form-control age-min" id="age-min-${ruleCount}-1" name="age_min[${ruleCount}][]" placeholder="From Age" min="0" required>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="age-max-${ruleCount}-1">Age Range:</label>
                                    <input type="number" class="form-control age-max" id="age-max-${ruleCount}-1" name="age_max[${ruleCount}][]" placeholder="To Age" min="0" required>
                                </div>
                                <div class="form-group flex-item">
                                    <label for="gender-${ruleCount}-1">Gender:</label>
                                    <select class="form-control gender" id="gender-${ruleCount}-1" name="genders[${ruleCount}][]" required>
                                        <option value="all">ALL</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                            <div class="center-buttons">
                                <button type="button" class="btn btn-danger remove-condition" style="display: none;">Remove Condition</button>
                            </div>
                        </div>
                    </div>
                    <div class="center-buttons">
                        <button type="button" class="btn btn-primary add-condition" data-rule="${ruleCount}">Add Condition</button>
                        <button type="button" class="btn btn-danger remove-rule" style="display: block;">Remove Rule</button>
                    </div>
                </div>
            `;
            $('#rules').append(ruleHtml);
            updateRemoveButtons();
            initializeConditionFields();
        });

        // Add new condition
        $(document).on('click', '.add-condition', function () {
            const ruleId = $(this).data('rule');
            conditionCount++;
            const conditionHtml = `
                <div class="condition-group" id="condition-${ruleId}-${conditionCount}">
                    <h6>Condition ${conditionCount}</h6>
                    <div class="flex-container">
                        <div class="form-group flex-item">
                            <label for="condition-type-${ruleId}-${conditionCount}">Condition Type:</label>
                            <select class="form-control condition-type" id="condition-type-${ruleId}-${conditionCount}" name="conditions[${ruleId}][]">
                                <option value="range">Range Condition</option>
                                <option value="comparison">Comparison Condition</option>
                            </select>
                        </div>
                        <div class="form-group flex-item">
                            <label for="parameter-${ruleId}-${conditionCount}">Parameter:</label>
                            <select class="form-control parameter" id="parameter-${ruleId}-${conditionCount}" name="parameters[${ruleId}][]">
                                <option value="Hemoglobin">Hemoglobin</option>
                                <option value="Glucose">Glucose</option>
                                <option value="Potassium">Potassium</option>
                                <option value="gl">GL</option>
                                <option value="Sodium">Sodium</option>
                            </select>
                        </div>
                        <div class="form-group flex-item range-condition" style="display: none;">
                            <label for="min-value-${ruleId}-${conditionCount}">Minimum Value:</label>
                            <input type="number" class="form-control min-value" id="min-value-${ruleId}-${conditionCount}" name="min_values[${ruleId}][]" placeholder="Enter minimum value">
                        </div>
                        <div class="form-group flex-item range-condition" style="display: none;">
                            <label for="max-value-${ruleId}-${conditionCount}">Maximum Value:</label>
                            <input type="number" class="form-control max-value" id="max-value-${ruleId}-${conditionCount}" name="max_values[${ruleId}][]" placeholder="Enter maximum value">
                        </div>
                        <div class="form-group flex-item comparison-condition" style="display: none;">
                            <label for="operator-${ruleId}-${conditionCount}">Operator:</label>
                            <select class="form-control operator" id="operator-${ruleId}-${conditionCount}" name="operators[${ruleId}][]">
                                <option value="greater">></option>
                                <option value="less"><</option>
                                <option value="equal">=</option>
                            </select>
                        </div>
                        <div class="form-group flex-item comparison-condition" style="display: none;">
                            <label for="value-${ruleId}-${conditionCount}">Value:</label>
                            <input type="number" class="form-control comparison-value" id="value-${ruleId}-${conditionCount}" name="comparison_values[${ruleId}][]" placeholder="Enter value">
                        </div>
                        <div class="form-group flex-item">
                            <label for="unit-${ruleId}-${conditionCount}">Unit:</label>
                            <select class="form-control unit" id="unit-${ruleId}-${conditionCount}" name="units[${ruleId}][]">
                                <option value="mg/dL">mg/dL</option>
                                <option value="g/dL">g/dL</option>
                                <option value="mmHg">mmHg</option>
                                <option value="%">%</option>
                                <option value="bpm">bpm</option>
                            </select>
                        </div>
                        <div class="form-group flex-item">
                            <label for="age-min-${ruleId}-${conditionCount}">Age Range:</label>
                            <input type="number" class="form-control age-min" id="age-min-${ruleId}-${conditionCount}" name="age_min[${ruleId}][]" placeholder="From Age" min="0" required>
                        </div>
                        <div class="form-group flex-item">
                            <label for="age-max-${ruleId}-${conditionCount}">Age Range:</label>
                            <input type="number" class="form-control age-max" id="age-max-${ruleId}-${conditionCount}" name="age_max[${ruleId}][]" placeholder="To Age" min="0" required>
                        </div>
                        <div class="form-group flex-item">
                            <label for="gender-${ruleId}-${conditionCount}">Gender:</label>
                            <select class="form-control gender" id="gender-${ruleId}-${conditionCount}" name="genders[${ruleId}][]" required>
                                <option value="all">ALL</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="center-buttons">
                        <button type="button" class="btn btn-danger remove-condition" style="display: block;">Remove Condition</button>
                    </div>
                </div>
            `;
            $(`#conditions-${ruleId}`).append(conditionHtml);
            updateRemoveButtons();
            initializeConditionFields();
        });

        // Remove condition
        $(document).on('click', '.remove-condition', function () {
            $(this).closest('.condition-group').remove();
            updateRemoveButtons();
        });

        // Remove rule
        $(document).on('click', '.remove-rule', function () {
            $(this).closest('.rule-group').remove();
            updateRemoveButtons();
        });

        // Remove disease code
        $(document).on('click', '.remove-disease-code', function () {
            $(this).closest('.disease-code').remove(); // Corrected selector
            updateRemoveButtons();
        });

        function updateRemoveButtons() {
    $('.remove-condition').each(function () {
        if ($(this).closest('.conditions').find('.condition-group').length <= 1) {
            $(this).hide();
        } else {
            $(this).show();
        }
    });

    $('.remove-rule').each(function () {
        if ($(this).closest('#rules').find('.rule-group').length <= 1) {
            $(this).hide();
        } else {
            $(this).show();
        }
    });

    $('.remove-disease-code').each(function () {
        if ($(this).closest('#disease-codes').find('.disease-code').length <= 1) { // Corrected selector
            $(this).hide();
        } else {
            $(this).show();
        }
    });
}

        initializeConditionFields();
    });
</script>

        <!-- Message Section -->
        <div id="message" class="alert" style="display: none; padding: 10px; border-radius: 5px;"></div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('rule-form');
                form.addEventListener('submit', function(event) {
                    event.preventDefault(); // Prevent the default form submission
            
                    const formData = new FormData(form);
                    fetch('/rulebase', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        const messageDiv = document.getElementById('message');
                        messageDiv.style.display = 'block'; // Make the message div visible
                        if (data.message.includes('successfully')) {
                            messageDiv.style.backgroundColor = 'green';
                            messageDiv.style.color = 'white';
                        } else {
                            messageDiv.style.backgroundColor = 'red';
                            messageDiv.style.color = 'white';
                        }
                        messageDiv.textContent = data.message;
                    })
                    .catch(error => {
                        const messageDiv = document.getElementById('message');
                        messageDiv.style.display = 'block'; // Make the message div visible
                        messageDiv.style.backgroundColor = 'red';
                        messageDiv.style.color = 'white';
                        messageDiv.textContent = 'An error occurred: ' + error.message;
                    });
                });
            });
            </script>

</body>
</html>


